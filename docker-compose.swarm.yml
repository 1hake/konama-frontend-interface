# Production Swarm configuration
services:
    konama-frontend:
        image: thegobc/konama-frontend:latest
        deploy:
            replicas: 1
            restart_policy:
                condition: on-failure
                delay: 10s
                max_attempts: 3
                window: 60s
            resources:
                limits:
                    memory: 1G
                    cpus: '0.5'
                reservations:
                    memory: 512M
                    cpus: '0.25'
            update_config:
                parallelism: 1
                delay: 10s
                failure_action: rollback
                order: stop-first
        labels:
            - 'traefik.enable=true'
            
            # HTTP to HTTPS redirect
            - 'traefik.http.routers.konama-frontend-http.rule=Host(`studio.fuzdi.fr`)'
            - 'traefik.http.routers.konama-frontend-http.entrypoints=web'
            - 'traefik.http.routers.konama-frontend-http.middlewares=https-redirect'
            
            # HTTPS router for the root domain
            - 'traefik.http.routers.konama-frontend.rule=Host(`studio.fuzdi.fr`)'
            - 'traefik.http.routers.konama-frontend.entrypoints=websecure'
            - 'traefik.http.routers.konama-frontend.tls.certresolver=letsencrypt'

            # HTTP to HTTPS redirect for www
            - 'traefik.http.routers.konama-frontend-www-http.rule=Host(`www.studio.fuzdi.fr`)'
            - 'traefik.http.routers.konama-frontend-www-http.entrypoints=web'
            - 'traefik.http.routers.konama-frontend-www-http.middlewares=https-redirect'
            
            # HTTPS router for the www subdomain
            - 'traefik.http.routers.konama-frontend-www.rule=Host(`www.studio.fuzdi.fr`)'
            - 'traefik.http.routers.konama-frontend-www.entrypoints=websecure'
            - 'traefik.http.routers.konama-frontend-www.tls.certresolver=letsencrypt'
            - 'traefik.http.routers.konama-frontend-www.middlewares=redirect-to-root'
            
            # HTTPS redirect middleware
            - 'traefik.http.middlewares.https-redirect.redirectscheme.scheme=https'
            - 'traefik.http.middlewares.https-redirect.redirectscheme.permanent=true'

            # Redirect middleware from www to root domain
            - 'traefik.http.middlewares.redirect-to-root.redirectregex.regex=^https?://www\.studio\.fuzdi\.fr/(.*)'
            - 'traefik.http.middlewares.redirect-to-root.redirectregex.replacement=https://studio.fuzdi.fr/$${1}'
            - 'traefik.http.middlewares.redirect-to-root.redirectregex.permanent=true'

            # Service configuration
            - 'traefik.http.services.konama-frontend.loadbalancer.server.port=3001'

        environment:
            NODE_ENV: production
            NEXT_PUBLIC_API_URL: https://studio.fuzdi.fr
            NEXT_PUBLIC_BASE_URL: https://studio.fuzdi.fr
            NEXT_PUBLIC_COMFY_API_URL: http://localhost:3000/api
            NEXT_PUBLIC_WORKFLOW_API_URL: http://localhost:4001
            PORT: 3001
        secrets:
            - IMAGE_GEN_ADMIN_OPENAI_API_KEY
        networks:
            - webnet

secrets:
    IMAGE_GEN_ADMIN_OPENAI_API_KEY:
        external: true
        name: konama_client_openai_api_key

networks:
    webnet:
        external: true
