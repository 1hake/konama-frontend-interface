# Production Swarm configuration
services:
    image-generation-admin:
        image: thegobc/image-generation-admin:latest
        deploy:
            replicas: 1
            restart_policy:
                condition: on-failure
                delay: 10s
                max_attempts: 3
                window: 60s
            resources:
                limits:
                    memory: 1G
                    cpus: '0.5'
                reservations:
                    memory: 512M
                    cpus: '0.25'
            update_config:
                parallelism: 1
                delay: 10s
                failure_action: rollback
                order: stop-first
        labels:
            - 'traefik.enable=true'
            - 'traefik.http.routers.champdavoine.rule=Host(`champdavoine.com`)'
            - 'traefik.http.routers.champdavoine.entrypoints=websecure'
            - 'traefik.http.routers.champdavoine.tls.certresolver=myresolver'
            - 'traefik.http.services.champdavoine.loadbalancer.server.port=3000'
        environment:
            NODE_ENV: production
        secrets:
            - konama_client_openai_api_key
        networks:
            - webnet
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s

secrets:
    konama_client_openai_api_key:
        external: true
        name: konama_client_openai_api_key

networks:
    webnet:
        external: true
